!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("ecsy"),require("three"),require("three/examples/jsm/loaders/GLTFLoader.js"),require("three/examples/jsm/webxr/VRButton.js"),require("three/examples/jsm/webxr/ARButton.js")):"function"==typeof define&&define.amd?define(["exports","ecsy","three","three/examples/jsm/loaders/GLTFLoader.js","three/examples/jsm/webxr/VRButton.js","three/examples/jsm/webxr/ARButton.js"],t):(e=e||self,function(){var s=e.ECSYTHREE,n=e.ECSYTHREE={};t(n,e.ECSY,e.THREE,e.GLTFLoader_js,e.VRButton_js,e.ARButton_js),n.noConflict=function(){return e.ECSYTHREE=s,n}}())}(this,(function(e,t,s,n,o,i){"use strict";class r{constructor(){this.reset()}reset(){this.value=!1}}class a{constructor(){this.fov=45,this.aspect=1,this.near=1,this.far=1e3,this.layers=0,this.handleResize=!0}reset(){}}class l{constructor(){this.reset()}reset(){this.leftHand=null,this.rightHand=null,this.camera=null}}class d extends t.TagComponent{}class h{reset(){}constructor(){this.active=!1,this.preset="default",this.seed=1,this.skyType="atmosphere",this.skyColor="",this.horizonColor="",this.lighting="distant",this.shadow=!1,this.shadowSize=10,this.lightPosition={x:0,y:1,z:-.2},this.fog=0,this.flatShading=!1,this.playArea=1,this.ground="flat",this.groundYScale=3,this.groundTexture="none",this.groundColor="#553e35",this.groundColor2="#694439",this.dressing="none",this.dressingAmount=10,this.dressingColor="#795449",this.dressingScale=5,this.dressingVariance={x:1,y:1,z:1},this.dressingUniformScale=!0,this.dressingOnPlayArea=0,this.grid="none",this.gridColor="#ccc"}}class c{constructor(){this.primitive="box"}reset(){this.primitive="box"}}class u{}class m{constructor(){this.value=null}reset(){this.value=null}}class p{constructor(){this.value=null}reset(){this.value=null}}class g{constructor(){this.scene=null,this.camera=null}reset(){this.scene=null,this.camera=null}}class v{constructor(){this.scene=null}reset(){this.scene=null}}class f{constructor(){this.texture="",this.type=""}reset(){this.texture="",this.type=""}}class y{reset(){}}class w{constructor(){this.position=new s.Vector3,this.rotation=new s.Vector3}copy(e){this.position.copy(e.position),this.rotation.copy(e.rotation)}reset(){this.position.set(0,0,0),this.rotation.set(0,0,0)}}class C{constructor(){this.reset()}reset(){this.value=!1}}class x{constructor(){this.vr=!1,this.ar=!1,this.antialias=!0,this.handleResize=!0,this.gammaOutput=!0,this.shadowMap=!0}}class S extends t.System{execute(){this.queries.entities.removed.forEach(e=>{var t=e.getRemovedComponent(m).value;e.getComponent(p,!0).value.getComponent(m).value.remove(t)}),this.queries.entities.added.forEach(e=>{var t,n=e.getComponent(c);switch(n.primitive){case"torus":t=new s.TorusBufferGeometry(n.radius,n.tube,n.radialSegments,n.tubularSegments);break;case"sphere":t=new s.IcosahedronBufferGeometry(n.radius,1);break;case"box":t=new s.BoxBufferGeometry(n.width,n.height,n.depth)}var o="torus"===n.primitive?10066176:16777215*Math.random(),i=new s.MeshLambertMaterial({color:o,flatShading:!0}),r=new s.Mesh(t,i);if(r.castShadow=!0,r.receiveShadow=!0,e.hasComponent(w)){var a=e.getComponent(w);r.position.copy(a.position),a.rotation&&r.rotation.set(a.rotation.x,a.rotation.y,a.rotation.z)}e.addComponent(m,{value:r})})}}S.queries={entities:{components:[c],listen:{added:!0,removed:!0}}};var b=(new n.GLTFLoader).setPath("/assets/");class E extends t.System{execute(){this.queries.entities.added.forEach(e=>{var t=e.getComponent(u);b.load(t.url,t=>{e.addComponent(m,{value:t.scene})})})}}E.queries={entities:{components:[u],listen:{added:!0}}};class M extends t.System{execute(){let e=this.queries.entities.results;for(let t=0;t<e.length;t++){let n=e[t],o=n.getComponent(f),i=new s.Group,r=new s.BoxBufferGeometry(100,100,100);if(r.scale(1,1,-1),"cubemap-stereo"===o.type){let e=q(o.textureUrl,12),t=[];for(let n=0;n<6;n++)t.push(new s.MeshBasicMaterial({map:e[n]}));let a=new s.Mesh(r,t);a.layers.set(1),i.add(a);let l=[];for(let t=6;t<12;t++)l.push(new s.MeshBasicMaterial({map:e[t]}));let d=new s.Mesh(r,l);d.layers.set(2),i.add(d),n.addComponent(m,{value:i})}else console.warn("Unknown skybox type: ",o.type)}}}function q(e,t){let n=[];for(let e=0;e<t;e++)n[e]=new s.Texture;return(new s.ImageLoader).load(e,(function(e){let t,s,o=e.height;for(let i=0;i<n.length;i++)s=(t=document.createElement("canvas")).getContext("2d"),t.height=o,t.width=o,s.drawImage(e,o*i,0,o,o,0,0,o,o),n[i].image=t,n[i].needsUpdate=!0})),n}M.queries={entities:{components:[f,t.Not(m)]}};class R extends t.System{processVisibility(e){e.forEach(e=>{e.getMutableComponent(m).value.visible=e.getComponent(C).value})}execute(){this.processVisibility(this.queries.entities.added),this.processVisibility(this.queries.entities.changed)}}R.queries={entities:{components:[C,m],listen:{added:!0,changed:[C]}}};class z{constructor(){this.value=null}}class T extends t.System{init(){window.addEventListener("resize",()=>{this.queries.renderers.results.forEach(e=>{var t=e.getMutableComponent(x);t.width=window.innerWidth,t.height=window.innerHeight})},!1)}execute(){this.queries.renderers.results.forEach(e=>{var t=e.getComponent(z).value;this.queries.renderPasses.results.forEach(e=>{var s=e.getComponent(g).scene.getComponent(m).value;this.queries.activeCameras.results.forEach(e=>{var n=e.getComponent(m).value;t.render(s,n)})})}),this.queries.uninitializedRenderers.results.forEach(e=>{var t=e.getComponent(x),n=new s.WebGLRenderer({antialias:t.antialias});t.animationLoop&&n.setAnimationLoop(t.animationLoop),n.setPixelRatio(window.devicePixelRatio),t.handleResize&&n.setSize(window.innerWidth,window.innerHeight),n.gammaOutput=t.gammaOutput,n.shadowMap.enabled=t.shadowMap,document.body.appendChild(n.domElement),(t.vr||t.ar)&&(n.xr.enabled=!0,t.vr&&document.body.appendChild(o.VRButton.createButton(n)),t.ar&&document.body.appendChild(i.ARButton.createButton(n))),e.addComponent(z,{value:n})}),this.queries.renderers.changed.forEach(e=>{var t=e.getComponent(x),s=e.getComponent(z).value;t.width===s.width&&t.height===s.height||s.setSize(t.width,t.height)})}}T.queries={uninitializedRenderers:{components:[x,t.Not(z)]},renderers:{components:[x,z],listen:{changed:[x]}},renderPasses:{components:[g]},activeCameras:{components:[a,r],listen:{added:!0}}};class L extends t.System{execute(){let e=this.queries.parent.added;for(var t=0;t<e.length;t++){var s=e[t],n=s.getComponent(p).value;if(n.hasComponent(m)){var o=n.getComponent(m).value,i=s.getComponent(m).value;o.add(i)}}var r=this.queries.transforms;for(let e=0;e<r.added.length;e++){let t=r.added[e],s=t.getComponent(w),n=t.getComponent(m).value;n.position.copy(s.position),n.rotation.set(s.rotation.x,s.rotation.y,s.rotation.z)}for(let e=0;e<r.changed.length;e++){let t=r.changed[e],s=t.getComponent(w),n=t.getComponent(m).value;n.position.copy(s.position),n.rotation.set(s.rotation.x,s.rotation.y,s.rotation.z)}}}L.queries={parent:{components:[p,m],listen:{added:!0}},transforms:{components:[m,w],listen:{added:!0,changed:[w]}}};class B extends t.System{init(){window.addEventListener("resize",()=>{this.queries.cameras.results.forEach(e=>{e.getComponent(a).handleResize&&(e.getMutableComponent(a).aspect=window.innerWidth/window.innerHeight)})},!1)}execute(){let e=this.queries.cameras.changed;for(let t=0;t<e.length;t++){let s=e[t],n=s.getComponent(a),o=s.getMutableComponent(m).value;o.aspect!==n.aspect&&(o.aspect=n.aspect,o.updateProjectionMatrix())}this.queries.camerasUninitialized.results.forEach(e=>{let t=e.getComponent(a),n=new s.PerspectiveCamera(t.fov,t.aspect,t.near,t.far);n.layers.enable(t.layers),e.addComponent(m,{value:n})})}}B.queries={camerasUninitialized:{components:[a,t.Not(m)]},cameras:{components:[a,m],listen:{changed:[a]}}};class G extends t.System{init(){this.initialized=!1;var e=new s.FontLoader;this.font=null,e.load("/assets/fonts/helvetiker_regular.typeface.json",e=>{this.font=e,this.initialized=!0})}execute(){this.font&&(this.queries.entities.changed.forEach(e=>{var t=e.getComponent(y),n=new s.TextGeometry(t.text,{font:this.font,size:1,height:.1,curveSegments:3,bevelEnabled:!0,bevelThickness:.03,bevelSize:.03,bevelOffset:0,bevelSegments:3});e.getMutableComponent(m).value.geometry=n}),this.queries.entities.added.forEach(e=>{var t=e.getComponent(y),n=new s.TextGeometry(t.text,{font:this.font,size:1,height:.1,curveSegments:3,bevelEnabled:!0,bevelThickness:.03,bevelSize:.03,bevelOffset:0,bevelSegments:3});Math.random();var o=new s.MeshStandardMaterial({color:16777215,roughness:.7,metalness:0}),i=new s.Mesh(n,o);e.addComponent(m,{value:i})}))}}G.queries={entities:{components:[y],listen:{added:!0,changed:!0}}};class j extends t.System{execute(){this.queries.environments.added.forEach(e=>{var t=document.createElement("canvas");t.width=2048,t.height=2048;var n=new s.Texture(t);n.wrapS=s.RepeatWrapping,n.wrapT=s.RepeatWrapping,n.repeat.set(10,10),this.environmentData={groundColor:"#454545",groundColor2:"#5d5d5d"};var o=t.getContext("2d");o.fillStyle=this.environmentData.groundColor,o.fillRect(0,0,2048,2048),o.fillStyle=this.environmentData.groundColor2;for(var i=Math.floor(10),r=0;r<i+1;r+=2)for(var a=0;a<i+1;a++)o.fillRect(Math.floor(204.8*(r+a%2)),Math.floor(204.8*a),Math.floor(204.8),Math.floor(204.8));n.needsUpdate=!0;var l=new s.MeshLambertMaterial({map:n});let d=e.getComponent(v).value.getComponent(m).value;var h=new s.PlaneBufferGeometry(202,202,63,63);let c=new s.Mesh(h,l);c.rotation.x=-Math.PI/2,c.receiveShadow=!0,e.addComponent(m,{value:c}),e.addComponent(p,{value:window.entityScene});d.fog=new s.Fog(3355443,20,100),d.background=new s.Color(3355443)})}}function P(e){e.registerSystem(L).registerSystem(B).registerSystem(T,{priority:1})}j.queries={environments:{components:[v,h],listen:{added:!0}}},e.Active=r,e.Camera=a,e.CameraRig=l,e.CameraSystem=B,e.Draggable=class{constructor(){this.reset()}reset(){this.value=!1}},e.Dragging=d,e.Environment=h,e.EnvironmentSystem=j,e.GLTFLoaderSystem=E,e.GLTFModel=u,e.Geometry=c,e.GeometrySystem=S,e.Material=class{constructor(){this.color=16711680}},e.Object3D=m,e.Parent=p,e.Position=class{constructor(){this.position=new s.Vector3}reset(){this.position.set(0,0,0)}},e.RenderPass=g,e.Rotation=class{constructor(){this.rotation=new s.Vector3}reset(){this.rotation.set(0,0,0)}},e.Scene=v,e.Sky=class{constructor(){}reset(){}},e.SkyBox=f,e.SkyBoxSystem=M,e.TextGeometry=y,e.TextGeometrySystem=G,e.Transform=w,e.TransformSystem=L,e.VRController=class{constructor(){this.id=0,this.controller=null}reset(){}},e.VisibilitySystem=R,e.Visible=C,e.WebGLRendererContext=z,e.WebGLRendererSystem=T,e.init=P,e.initializeDefault=function(e=new t.World,n){P(e);let o=n.animationLoop;if(!o){const t=new s.Clock;o=()=>{e.execute(t.getDelta(),t.elapsedTime)}}let i=e.createEntity().addComponent(v).addComponent(m,{value:new s.Scene}),r=e.createEntity().addComponent(x,{ar:n.ar,vr:n.vr,animationLoop:o});var d=null,h=null;n.ar||n.vr?h=e.createEntity().addComponent(l).addComponent(p,{value:i}):d=e.createEntity().addComponent(a,{fov:90,aspect:window.innerWidth/window.innerHeight,near:1,far:1e3,layers:1,handleResize:!0});let c=e.createEntity().addComponent(g,{scene:i,camera:d});return{world:e,entities:{scene:i,camera:d,cameraRig:h,renderer:r,renderPass:c}}},Object.defineProperty(e,"__esModule",{value:!0})}));
